{% extends 'backoffice/base.html' %}
{% load i18n %}

{% block title %}{% if object %}Editar Propiedad{% else %}Crear Propiedad{% endif %}{% endblock %}
{% block page_title %}{% if object %}Editar Propiedad{% else %}Nueva Propiedad{% endif %}{% endblock %}

{% block extra_css %}
{{ form.media.css }}
{% endblock %}

{% block extra_js %}
{{ form.media.js }}
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-lg shadow-md p-6">
        <form method="post" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}
            
            {% if form.errors %}
            <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg">
                <p class="font-semibold">Errores en el formulario:</p>
                <ul class="list-disc list-inside">
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                        <li>{{ field }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            <!-- Tabs de Idiomas -->
            <div>
                <h3 class="text-lg font-semibold mb-4 text-gray-900">Contenido Traducible</h3>
                <p class="text-sm text-gray-600 mb-4">Completa la informaci√≥n en todos los idiomas (m√≠nimo espa√±ol)</p>
                
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex space-x-4">
                        <button type="button" class="lang-tab active border-b-2 border-primary-600 py-2 px-4 text-sm font-medium text-primary-600" data-lang="es">
                            üá™üá∏ Espa√±ol
                        </button>
                        <button type="button" class="lang-tab border-b-2 border-transparent py-2 px-4 text-sm font-medium text-gray-500 hover:text-gray-700" data-lang="ca">
                            üá®üáπ Catal√†
                        </button>
                        <button type="button" class="lang-tab border-b-2 border-transparent py-2 px-4 text-sm font-medium text-gray-500 hover:text-gray-700" data-lang="en">
                            üá¨üáß English
                        </button>
                        <button type="button" class="lang-tab border-b-2 border-transparent py-2 px-4 text-sm font-medium text-gray-500 hover:text-gray-700" data-lang="de">
                            üá©üá™ Deutsch
                        </button>
                    </nav>
                </div>
                
                <!-- Contenido por idioma -->
                <div class="lang-content active" data-lang="es">
                    <h4 class="font-semibold mb-4">Espa√±ol</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">T√≠tulo *</label>
                            {{ form.title }}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n Corta *</label>
                            {{ form.short_description }}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n Completa *</label>
                            {{ form.description }}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Caracter√≠sticas</label>
                            {{ form.features }}
                            <p class="text-xs text-gray-500 mt-1">Una por l√≠nea: Piscina, Garaje, Terraza...</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Meta Title SEO</label>
                                {{ form.meta_title }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Meta Description SEO</label>
                                {{ form.meta_description }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="lang-content hidden" data-lang="ca">
                    <h4 class="font-semibold mb-4">Catal√†</h4>
                    <p class="text-sm text-gray-500 mb-4">Traduce el contenido al catal√°n</p>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">T√≠tol</label>
                            <input type="text" name="title_ca" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥ Curta</label>
                            <textarea name="short_description_ca" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥ Completa</label>
                            <textarea name="description_ca" rows="8" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Caracter√≠stiques</label>
                            <textarea name="features_ca" rows="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="lang-content hidden" data-lang="en">
                    <h4 class="font-semibold mb-4">English</h4>
                    <p class="text-sm text-gray-500 mb-4">Translate content to English</p>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                            <input type="text" name="title_en" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Short Description</label>
                            <textarea name="short_description_en" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Full Description</label>
                            <textarea name="description_en" rows="8" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Features</label>
                            <textarea name="features_en" rows="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="lang-content hidden" data-lang="de">
                    <h4 class="font-semibold mb-4">Deutsch</h4>
                    <p class="text-sm text-gray-500 mb-4">Inhalt auf Deutsch √ºbersetzen</p>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Titel</label>
                            <input type="text" name="title_de" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kurzbeschreibung</label>
                            <textarea name="short_description_de" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Vollst√§ndige Beschreibung</label>
                            <textarea name="description_de" rows="8" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Eigenschaften</label>
                            <textarea name="features_de" rows="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Campos No Traducibles -->
            <div class="bg-gray-50 p-6 rounded-lg space-y-6">
                <h3 class="text-lg font-semibold text-gray-900">Informaci√≥n T√©cnica</h3>
                
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Slug *</label>
                        {{ form.slug }}
                        <p class="text-xs text-gray-500 mt-1">Se genera autom√°ticamente</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Propiedad *</label>
                        {{ form.property_type }}
                    </div>
                </div>
                
                <div class="grid grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Precio (‚Ç¨) *</label>
                        {{ form.price }}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Superficie (m¬≤) *</label>
                        {{ form.surface_area }}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Habitaciones *</label>
                        {{ form.bedrooms }}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ba√±os *</label>
                        {{ form.bathrooms }}
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ubicaci√≥n *</label>
                    {{ form.location }}
                    <p class="text-xs text-gray-500 mt-1">Ej: Palma de Mallorca, Son Vida</p>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Latitud (opcional)</label>
                        {{ form.latitude }}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Longitud (opcional)</label>
                        {{ form.longitude }}
                    </div>
                </div>
                
                <div class="flex gap-6">
                    <div class="flex items-center">
                        {{ form.is_sold }}
                        <label for="{{ form.is_sold.id_for_label }}" class="ml-2 text-sm text-gray-700">Vendido</label>
                    </div>
                    <div class="flex items-center">
                        {{ form.is_featured }}
                        <label for="{{ form.is_featured.id_for_label }}" class="ml-2 text-sm text-gray-700">Destacado en portada</label>
                    </div>
                </div>
            </div>
            
            <!-- Secci√≥n de Im√°genes -->
            <div class="bg-gray-50 p-6 rounded-lg space-y-6">
                <h3 class="text-lg font-semibold text-gray-900">Galer√≠a de Im√°genes</h3>
                
                {% if object and existing_images %}
                <div>
                    <h4 class="font-semibold text-gray-900 mb-3">Im√°genes Actuales</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        {% for img in existing_images %}
                        <div class="relative group">
                            <img src="{{ img.image.url }}" alt="Imagen {{ forloop.counter }}" class="w-full h-32 object-cover rounded-lg">
                            {% if img.is_primary %}
                            <span class="absolute top-2 left-2 px-2 py-1 bg-yellow-500 text-white text-xs rounded">Principal</span>
                            {% endif %}
                            <div class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition flex items-center justify-center rounded-lg">
                                <a href="/admin/properties/propertyimage/{{ img.pk }}/delete/" target="_blank" class="text-white hover:text-red-300">
                                    <i class="fas fa-trash text-2xl"></i>
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        Para eliminar o reordenar im√°genes, haz clic en el icono de papelera o usa el 
                        <a href="/admin/properties/property/{{ object.pk }}/change/" target="_blank" class="text-primary-600 hover:underline">admin de Django</a>
                    </p>
                </div>
                {% endif %}
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        {% if object %}A√±adir Nuevas Im√°genes{% else %}Im√°genes de la Propiedad *{% endif %}
                    </label>
                    <input type="file" name="images" multiple accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    <p class="text-xs text-gray-500 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        Puedes seleccionar m√∫ltiples im√°genes. La primera ser√° la imagen principal.
                    </p>
                </div>
            </div>
            
            <div class="flex justify-end space-x-4 pt-6 border-t">
                <a href="{% url 'backoffice:property_list' %}" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancelar
                </a>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-save mr-2"></i>
                    {% if object %}Actualizar Propiedad{% else %}Crear Propiedad{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.lang-tab');
    const contents = document.querySelectorAll('.lang-content');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            const lang = this.dataset.lang;
            
            tabs.forEach(t => {
                t.classList.remove('active', 'border-primary-600', 'text-primary-600');
                t.classList.add('border-transparent', 'text-gray-500');
            });
            
            this.classList.add('active', 'border-primary-600', 'text-primary-600');
            this.classList.remove('border-transparent', 'text-gray-500');
            
            contents.forEach(content => {
                if (content.dataset.lang === lang) {
                    content.classList.remove('hidden');
                    content.classList.add('active');
                } else {
                    content.classList.add('hidden');
                    content.classList.remove('active');
                }
            });
        });
    });
});
</script>
{% endblock %}
